<?xml version="1.0" encoding="utf-8"?>
<ui:DraggablePanel xmlns:mx="http://www.adobe.com/2006/mxml"
				   xmlns:ui="weave.ui.*"
				   implements="weave.api.ui.ILinkableContainer"
				   width="400" height="300" layout="absolute"
				   resize="draggablepanel1_resizeHandler(event)" title="Document Viewer"
				   creationComplete="handleCreationComplete(event)">	
	<mx:VBox height="100%" width="100%" >
	<mx:Canvas id="pdfSpace" height="100%" width="100%" />
	<mx:Script>
		<![CDATA[
			import mx.containers.Canvas;
			import mx.effects.Move;
			import mx.events.FlexEvent;
			import mx.events.ResizeEvent;
			import mx.rpc.AsyncToken;
			import mx.rpc.events.FaultEvent;
			import mx.rpc.events.ResultEvent;
			
			import weave.Weave;
			import weave.WeaveProperties;
			import weave.api.WeaveAPI;
			import weave.api.core.ILinkableHashMap;
			import weave.api.data.IDataRowSource;
			import weave.api.registerLinkableChild;
			import weave.api.reportError;
			import weave.data.DataSources.WeaveDataSource;
			import weave.services.AMF3Servlet;
			import weave.services.addAsyncResponder;
			
			private var _pdfFile:FileReference = new FileReference();
			private var _pdfLoader:URLLoader = new URLLoader();
			private var isURL:Boolean = false;
			//Re-useable movieclip object for the converted pdf.
			private var swfMovieClip:MovieClip = new MovieClip();
			private var totalSlideFrames:int = 0;
			
			
			protected function handleCreationComplete(event:FlexEvent):void
			{
				_pdfFile.addEventListener(Event.SELECT, pdfFileSelectedHandler);
				_pdfFile.addEventListener(ProgressEvent.PROGRESS, handleProgress);
				_pdfFile.addEventListener(Event.COMPLETE, pdfFileLoadCompleteHandler);
				_pdfFile.addEventListener(IOErrorEvent.IO_ERROR, fileErrorHandler);
			}
			
			private function pdfFileSelectedHandler(event:Event):void
			{
				if( swfLoader.content != null )
				{
					swfLoader.unload();
					pdfSpace.rawChildren.removeChild(swfMovieClip);
					swfMovieClip = new MovieClip();
				}
				_pdfFile.load();
				WeaveAPI.ProgressIndicator.addTask(_pdfFile);
			}
			
			private function handleProgress(event:ProgressEvent):void
			{
				WeaveAPI.ProgressIndicator.updateTask(_pdfFile, event.bytesLoaded / event.bytesTotal);
			}
			
			private var _servlet:AMF3Servlet = null;
			
			private function pdfFileLoadCompleteHandler(event:Event):void
			{
				WeaveAPI.ProgressIndicator.removeTask(_pdfFile);
				if (_pdfFile.data == null)
				{
					return;
				}
				
				_servlet = new AMF3Servlet(serverIP.text + "WeaveServices/DataService");
				registerLinkableChild(this, _servlet);
				
				pdfSelected.text = _pdfFile.name;
				
				isURL = false;
				
				var token:AsyncToken = _servlet.invokeAsyncMethod("convertPDF",[_pdfFile.name,_pdfFile.data]);
				addAsyncResponder(token, handleServletResponse, handleServletError, token);
			}
			
			var swfLoader:Loader = new Loader();
			
			private function handleServletResponse(event:ResultEvent, token:Object = null):void
			{
				if( isURL )
				{
					var getSWFLink:URLRequest = new URLRequest(serverIP.text + pdfURL.text.substring(pdfURL.text.lastIndexOf("/"),pdfURL.text.lastIndexOf(".")) + ".swf");
					trace( serverIP.text + pdfURL.text.substring(pdfURL.text.lastIndexOf("/"),pdfURL.text.lastIndexOf(".")) + ".swf");
				}
				else
				{
					var getSWFLink:URLRequest = new URLRequest(serverIP.text + _pdfFile.name.substr(0,_pdfFile.name.lastIndexOf(".")) + ".swf");
					trace( serverIP.text + _pdfFile.name.substr(0,_pdfFile.name.lastIndexOf(".")) + ".swf" );
				}
				swfLoader.contentLoaderInfo.addEventListener(Event.COMPLETE, handleSWFDownload);
				swfLoader.contentLoaderInfo.addEventListener(ProgressEvent.PROGRESS, progress);
				swfLoader.load(getSWFLink);
				trace(event.message);
				trace(event.result);
				trace(token);
			}
			
			private function progress(e:ProgressEvent):void
			{
				trace(e.bytesLoaded / e.bytesTotal);
			}
			
			private function handleSWFDownload(e:Event):void
			{
				swfMovieClip = e.currentTarget.content;
				
				swfMovieClip.x = pdfSpace.x;
				swfMovieClip.y = pdfSpace.y;
				swfMovieClip.width = pdfSpace.width;
				swfMovieClip.height = pdfSpace.height;
				pdfSpace.rawChildren.addChild(swfMovieClip);
				
				totalSlideFrames = swfMovieClip.totalFrames;
			}
			
			private function handleServletError(event:FaultEvent, token:Object = null):void
			{
				reportError(event);
			}
			
			private function fileErrorHandler(event:IOErrorEvent):void
			{
				reportError(event);
			}
			
			protected function draggablepanel1_resizeHandler(event:ResizeEvent):void
			{
				swfMovieClip.width = pdfSpace.width;
				swfMovieClip.height = pdfSpace.height;
				this.invalidateDisplayList();
			}
			
			protected function selectPDFButton(event:MouseEvent):void
			{
				try
				{
					var fileTypes:Array = [new FileFilter("PDF Files", "*.pdf")];
					_pdfFile.browse(fileTypes);
				}
				catch(e:Error)
				{
					reportError(e);
				}
				
			}
			
			protected function loadPDF(event:MouseEvent):void
			{
				if( swfLoader.content != null )
				{
					swfLoader.unload();
					pdfSpace.rawChildren.removeChild(swfMovieClip);
					swfMovieClip = new MovieClip();
				}
				
				var url:URLRequest = new URLRequest(pdfURL.text); 
				_pdfLoader.dataFormat = URLLoaderDataFormat.BINARY;				
				_pdfLoader.addEventListener(Event.COMPLETE, loaderOnComplete);
				_pdfLoader.addEventListener(IOErrorEvent.IO_ERROR, fileErrorHandler);
				_pdfLoader.load(url); 
			}
			
			private function loaderOnComplete(event:Event):void
			{
				if (_pdfLoader.data == null)
				{
					return;
				}
				
				_servlet = new AMF3Servlet(serverIP.text + "WeaveServices/DataService");
				registerLinkableChild(this, _servlet);
				
				//get filename.
				
				isURL = true;
				
				var token:AsyncToken = _servlet.invokeAsyncMethod("convertPDF",[pdfURL.text.substring(pdfURL.text.lastIndexOf("/")),_pdfLoader.data]);
				addAsyncResponder(token, handleServletResponse, handleServletError, token);
			
			}
			
			protected function pageBack(event:MouseEvent):void
			{
				if( swfMovieClip.totalFrames > 0 )
				{
					swfMovieClip.gotoAndStop(swfMovieClip.currentFrame-1);
				}				
			}
			
			protected function pageForward(event:MouseEvent):void
			{
				if( swfMovieClip.totalFrames > 0 )
				{
					swfMovieClip.nextFrame();					
				}
			}
			
			public function getLinkableChildren():ILinkableHashMap
			{
				return null;
			}
			
		]]>
	</mx:Script>
	<mx:HBox width="100%" height="5%" horizontalAlign="center">
		<mx:Image id="leftArrow" width="30" height="100%" click="pageBack(event)"
				  source="@Embed(source='/weave/resources/images/collab/docViewerArrowLeft.png')"/>
		<mx:Image id="rightArrow" width="30" height="100%" click="pageForward(event)"
				  source="@Embed(source='/weave/resources/images/collab/docViewerArrowRight.png')"/>
	</mx:HBox>
	</mx:VBox>
	
	<ui:ControlPanel>
		<mx:VBox>
			<mx:HBox>
				<mx:Label text="Server IP:"/>
				<mx:TextInput id="serverIP" text="http://localhost:8080/"/>
			</mx:HBox>
			<mx:HBox>
				<mx:Label text="Enter URL of PDF:"/>
				<mx:TextInput id="pdfURL"/>
				<mx:Button label="Load" click="loadPDF(event)"/>
			</mx:HBox>
			<mx:HBox>
				<mx:Label text="---  OR  ---"/>
			</mx:HBox>
			<mx:HBox>
				<mx:Label text="Select PDF file:"/>
				<ui:TextInputWithPrompt id="pdfSelected" prompt="{lang('Select a CSV file.')}" />
				<mx:Button label="Load PDF"  click="selectPDFButton(event)"/>
			</mx:HBox>
		</mx:VBox>
	</ui:ControlPanel>
</ui:DraggablePanel>
