<?xml version="1.0" encoding="utf-8"?>
<!--
/*
Weave (Web-based Analysis and Visualization Environment)
Copyright (C) 2008-2011 University of Massachusetts Lowell

This file is a part of Weave.

Weave is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License, Version 3,
as published by the Free Software Foundation.

Weave is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with Weave.  If not, see <http://www.gnu.org/licenses/>.
*/
-->
<ui:DraggablePanel
	xmlns="weave.ui.infomap.*" xmlns:mx="http://www.adobe.com/2006/mxml" 
	xmlns:ui="weave.ui.*"
	horizontalScrollPolicy="off" verticalScrollPolicy="off"
	borderThickness="0"
	title="InfoMap Prototype"
	clipContent="true"
	autoLayout="true"
	paddingLeft="5"
	paddingTop="5"
	>
	
	<mx:Script>
		<![CDATA[
			import mx.binding.utils.BindingUtils;
			import mx.collections.ArrayCollection;
			import mx.collections.Sort;
			import mx.collections.SortField;
			import mx.controls.Alert;
			import mx.controls.Image;
			import mx.controls.dataGridClasses.DataGridColumn;
			import mx.events.CloseEvent;
			import mx.events.CollectionEvent;
			import mx.rpc.AsyncToken;
			import mx.rpc.Responder;
			import mx.rpc.events.FaultEvent;
			import mx.rpc.events.ResultEvent;
			import mx.utils.StringUtil;
			import mx.utils.XMLUtil;
			
			import weave.Weave;
			import weave.api.WeaveAPI;
			import weave.api.data.IAttributeColumn;
			import weave.api.data.IQualifiedKey;
			import weave.api.linkBindableProperty;
			import weave.api.linkSessionState;
			import weave.api.newLinkableChild;
			import weave.api.registerLinkableChild;
			import weave.core.LinkableHashMap;
			import weave.core.LinkableString;
			import weave.core.UIUtils;
			import weave.data.KeySets.KeySet;
			import weave.services.DelayedAsyncResponder;
			import weave.services.jquery.JQueryCaller;
			import weave.ui.CustomContextMenuManager;
			import weave.ui.infomap.InfoMapLoader;
			import weave.ui.infomap.admin.InfoMapAdminInterface;
			import weave.ui.infomap.core.DateRangeFilter;
			import weave.ui.infomap.core.FilterableInfoMapNode;
			import weave.ui.infomap.layout.NodeHandler;
			import weave.ui.infomap.utils.DateUtils;
			import weave.utils.BitmapUtils;
			import weave.utils.ColumnUtils;
			import weave.utils.PopUpUtils;
			import weave.utils.ProbeTextUtils;
			
			/**
			 * @public
			 * This is mapping of a link to a node where each node is a defined by a query of keywords,operator and filters
			 * */
			public const nodes:LinkableHashMap = newLinkableChild(this, LinkableHashMap,handleNodesChildListChange);
			
			/**
			 * @public
			 * This is mapping of a link to a document object. 
			 * All the nodes within this panel will point to document objects in this map only.
			 * When a query is made by each node, the documents retrieved are stored in this map.
			 * */
			public const docs:LinkableHashMap = newLinkableChild(this,LinkableHashMap);
			
			/**
			 * @public
			 * this search keyword will apply to all the nodes within the panel
			 * This is not a query keyword. This is used only to search within the documents
			 * of each node.
			 * */
			public var globalSearchKeyword:LinkableString = new LinkableString('');
			
			[Bindable]
			public var globalDateFilter:DateRangeFilter = new DateRangeFilter();
			
			
			
			override protected function constructor():void
			{
				super.constructor();
			}
			
			override protected function childrenCreated():void
			{
				super.childrenCreated();
				UIUtils.linkDisplayObjects(map,nodes,false);
				sortByTitle();
//				globalDateFilter.endDate.addImmediateCallback(this,handleEndDateChange);
//				globalDateFilter.startDate.addImmediateCallback(this,handleStartDateChange);
				linkBindableProperty(globalSearchKeyword,globalSearchTextInput,"text");
			}
			
			private function handlePanelResize():void
			{
				map.validateNow();
//				searchBox.x = (map.width-searchBox.width);
			}
			
//			private function handleEndDateChange():void
//			{
//				var e:Date = DateUtils.getDateFromString(globalDateFilter.endDate.value);
//				
////				endDateText.text = DateUtils.getDateInStringFormat(e);
//			}
//			
//			private function handleStartDateChange():void
//			{
//				var s:Date = DateUtils.getDateFromString(globalDateFilter.startDate.value);
//				
////				startDateText.text = DateUtils.getDateInStringFormat(s);
//			}
			
			
			private function handleKeyUp(event:KeyboardEvent):void
			{
				if(event.keyCode == Keyboard.ENTER)
					handleAddNodeButtonClick();
			}
			private function handleAddNodeButtonClick():void
			{
				if(nodeComboBox.selectedItem == 'Add a Query Node')
					addInfoMapNode(keywordsInput.text);
				else if (nodeComboBox.selectedItem == 'Add a Map Node')
					addInfoMapLink(keywordsInput.text);
			}
			
			private function addInfoMapLink(mapName:String):void
			{
				var className:String = getQualifiedClassName(LinkToInfoMapComponent).split("::")[1];
				var linkNodeName:String = nodes.generateUniqueName(className);
				var linkNode:LinkToInfoMapComponent = new LinkToInfoMapComponent();
				linkNode = nodes.requestObject(linkNodeName,LinkToInfoMapComponent,false);
				linkNode.mapNameTextArea.text = mapName;
//				linkNode.width = 100;
//				linkNode.height = 50;
				
			}
			
			private function handleNodesChildListChange():void
			{
				//TODO:adjust the coordinates of single docs
			}
			
			public function addInfoMapNode(query:String,op:String=null):void
			{
				var className:String = getQualifiedClassName(NodeHandler).split("::")[1];
				var nodeName:String = nodes.generateUniqueName(className);
				var nodeHandler:NodeHandler= new NodeHandler();
				nodeHandler = nodes.requestObject(nodeName,NodeHandler,false);
				linkBindableProperty(nodeHandler.defaultBorderColor,defaultNodeColor,"selectedColor");
				linkBindableProperty(nodeHandler.selectedBorderColor,selectedNodeColor,"selectedColor");
				linkBindableProperty(nodeHandler.defaultThumbnailBorderColor,defaultThumbnailBorder,"selectedColor");
				linkBindableProperty(nodeHandler.selectedThumbnailBorderColor,selectedThumbnailBorder,"selectedColor");
				
				nodeHandler.node.keywords.value = query;
				if(op ==null)
				{
					//TODO: should take value from RadioButton. Value was null when last tried.
					nodeHandler.node.operator.value = "OR";	
				}
				else{
					
					nodeHandler.node.operator.value = op;
//					operatorButton.selectedValue = op;
				}
//				nodeLayout.node.dateFilter.startDate.value = startDateText.text;
//				nodeLayout.node.dateFilter.endDate.value = endDateText.text;
			}
			
			private var loader:URLLoader = null;
			private function addRssFeed():void
			{
				var url:String = feedURL.text;
				url = StringUtil.trim(url);
				if(url == "")
				{
					errorMsg.visible = true;
					return;	
				}
				
				var title:String = feedTitle.text;
				title = StringUtil.trim(title);
				if(title == "")
				{
					errorMsg.visible = true;	
					return;
				}	
								
				InfoMapAdminInterface.instance.addRssFeed(feedTitle.text,feedURL.text);
				sortByTitle();
				
				errorMsg.visible = false;
			}
			
			private function deleteRssFeed():void
			{
				if(grid.selectedItem == null)
					return;

				PopUpUtils.confirm(
					this,
					"Confirm delete",
					'Delete Feed entry:  "'+(grid.selectedItem as Array)[0]+'"?',
					del
				);
				
				function del():void{
					
					var url:String = (grid.selectedItem as Array)[1];
					
					if (url =="")
						return;
					
					InfoMapAdminInterface.instance.deleteRssFeed(url);
					sortByTitle();
				}
			}
			
			private function sortByTitle():void
			{
				var dp:ArrayCollection = grid.dataProvider as ArrayCollection;
				var sort:Sort = new Sort();
				var sortF:SortField = new SortField("Title",true,false);
				sort.fields = [sortF];
				dp.sort = sort;
			}
			
			private function startIndexing():void
			{
				WeaveAPI.URLRequestUtils.getURL(new URLRequest("http://129.63.8.219:8080/solr/select?clean=false&commit=true&qt=%2Fdataimport&command=full-import"));
				
			}
			
			
			private function handleDateFilter():void
			{
				DateFilterComponent.openInstance(this,globalDateFilter);
			}
			
			private function handleSelectAll():void
			{
				var handlers:Array = nodes.getObjects();
				
				for (var i:int = 0;i<handlers.length;i++)
				{
					if(handlers[i] is NodeHandler)
						(handlers[i] as NodeHandler).node.selected.value = selectAllCheckBox.selected;
					
				}
			
				//force callback so in case if the search text is already enetred nodes are informed.
				//globalSearchKeyword.triggerCallbacks();
				
			}
			
//			private function clearDateFilter():void
//			{
//				startDateText.text = '';
//				endDateText.text = '';
//			
//			}
			
			private function handleNodeComboBoxChange():void
			{
				if(nodeComboBox.selectedItem == 'Add a Query Node')
					keywordsInput.toolTip = 'Enter keywords to query';
				else
					keywordsInput.toolTip = 'Enter a name to link to an Infomap';
			}
			
			
			
			private var _fileLoader:FileReference = null;
			/**
			 * browseForfiles: opens up a file browser window to upload CSV files 
			 **/
			private function browse():void
			{
				if(_fileLoader == null)
				{
					_fileLoader = new FileReference();
					_fileLoader.addEventListener(Event.SELECT, handleDatasetSelected);
					_fileLoader.addEventListener(Event.COMPLETE, handleDatasetLoaded);
				}
				
				_fileLoader.browse();
			}
			
			
			private function handleDatasetSelected(event:Event):void
			{
				_fileLoader.load();
			}
			
			private var _mapImage:BitmapData
			private var imgLoader:Loader = new Loader();
			private function handleDatasetLoaded(event:Event):void
			{
				imageURL.text = _fileLoader.name;
				
//				map.setStyle("backgroundImage",_fileLoader.data);
				
				
				imgLoader.contentLoaderInfo.addEventListener(Event.COMPLETE,handleLoaderComplete);
				imgLoader.loadBytes(_fileLoader.data);
				
				
			}
			
			private function handleLoaderComplete(event:Event):void
			{
				var imgBitMap:Bitmap = Bitmap(imgLoader.content);
				
				BitmapUtils.drawCenteredIcon(map.graphics,map.x+map.width/2,map.y+map.height/2,imgBitMap.bitmapData);
			}
			
			private function saveImage(event:Event):void
			{
				
				_fileLoader.save(_fileLoader.data,_fileLoader.name);
			}
			
			private function clearImage():void
			{
				map.graphics.clear();
			}
		]]>
	</mx:Script>
	<!--the resize code is required so that the content is clipped by the canvas-->
	<mx:Canvas backgroundImage="" id="map" clipContent="true" width="100%" height="100%" autoLayout="false" 
			   verticalScrollPolicy="off" horizontalScrollPolicy="off" 
			   resize="map.scrollRect=new Rectangle(0,0,map.width,map.height);handlePanelResize();"><!--For clipping the content at the edges-->
				<mx:HBox paddingLeft="5" paddingTop="5">
					<mx:HBox>
						<mx:ComboBox id="nodeComboBox" dataProvider="{['Add a Query Node','Add a Map Node']}" fontWeight="bold" change="handleNodeComboBoxChange()"/>
						<mx:TextInput keyUp="handleKeyUp(event)" id="keywordsInput" enabled="true" cornerRadius="5" borderStyle="solid" toolTip="Separate your keywords by space to apply the operator correctly"/>
						<mx:Button label="Add" id="addNodeButton" click="handleAddNodeButtonClick()"/>
					</mx:HBox>
					<!--<mx:HBox>
						<mx:Label text="Operator: "/>
						<mx:RadioButtonGroup id="operatorButton" enabled="true"/>
						<mx:RadioButton groupName="operatorButton" value="OR" label="OR"/>
						<mx:RadioButton groupName="operatorButton" value="AND" label="AND" selected="true"/>
					</mx:HBox>
					<mx:HBox>
						<mx:Label text="Date Range: "/>
						<mx:TextInput  cornerRadius="5" borderStyle="solid" editable="false" id="startDateText" width="75" />
							<mx:Label text="TO"/>
						<mx:TextInput  cornerRadius="5" borderStyle="solid" editable="false" id="endDateText" width="75"/>
						<mx:LinkButton textDecoration="underline" color="blue" fontWeight="normal" label="Select" click="handleDateFilter()"/>
						<mx:LinkButton textDecoration="underline" color="blue" fontWeight="normal" label="Clear" click="clearDateFilter()"/>
					</mx:HBox>-->
					<mx:Spacer width="150"/>
					<mx:VBox>
						<mx:HBox>
							<mx:Label fontWeight="bold" text="Search in Selected Nodes:"/>
							<mx:TextInput id="globalSearchTextInput" borderStyle="solid" cornerRadius="5" width="200" />
							<mx:LinkButton textDecoration="underline" color="blue" fontWeight="normal" label="Add Date Filter in Selected Nodes" click="handleDateFilter()"/>
							<mx:Spacer width="50"/>
						</mx:HBox>
						<mx:CheckBox id="selectAllCheckBox" change="handleSelectAll()" label="Select All Nodes" selected="false"/>
					</mx:VBox>
				</mx:HBox>
				
		
		</mx:Canvas>
	<ui:ControlPanel id="ctrlPanel">
		<mx:VBox label="Basic Settings">
			<mx:HBox>
				<mx:Label text="Set Background Image: "/>
				<mx:TextInput editable="false" id="imageURL"/>
				<mx:Button label="Browse" click="browse()"/>
				<mx:Button label="Clear" click="clearImage()"/>
				<mx:Button label="Save" click="saveImage(event)"/>
			</mx:HBox>
			<mx:Spacer height="50"/>
			<mx:HBox>
				<mx:VBox>
					<mx:HBox>
						<mx:ColorPicker id="defaultNodeColor" />
						<mx:Label width="150" text="Default Node Color"/>				
					</mx:HBox>
					
					<mx:HBox>
						<mx:ColorPicker id="selectedNodeColor"/>
						<mx:Label width="150" text="Selected Node Color"/>				
					</mx:HBox>
				</mx:VBox>
				<mx:VBox>
					<mx:HBox>
						<mx:ColorPicker id="defaultThumbnailBorder"/>
						<mx:Label width="200" text="Default Thumbnail Border Color"/>				
					</mx:HBox>
					
					<mx:HBox>
						<mx:ColorPicker id="selectedThumbnailBorder"/>
						<mx:Label width="200" text="Selected Thumbnail Border Color"/>				
					</mx:HBox>
				</mx:VBox>
			</mx:HBox>
		</mx:VBox>
		<mx:VBox id="feedsControlPanel" label="Add/Remove Feeds">
		<mx:Label text="Enter RSS Feed: " />
		<mx:HBox>
			<mx:Label text="Title"/>
			<mx:TextInput width="100" id="feedTitle" borderStyle="solid" cornerRadius="5" />
			<mx:Label text="URL"/>
			<mx:TextInput width="300" id="feedURL" borderStyle="solid" cornerRadius="5" />
			<mx:Button label="Add" click="addRssFeed()" />
		</mx:HBox>	
		<mx:Label id="errorMsg" color="red" fontWeight="bold" text="Both fields are required." visible="false"/>
			<mx:DataGrid id="grid" dataProvider="{InfoMapAdminInterface.instance.rssFeeds}" width="100%">
				<mx:columns>
					<mx:DataGridColumn dataField="0" sortDescending="true" headerText="Title"/>
					<mx:DataGridColumn dataField="1" headerText="URL"/>
				</mx:columns>
			</mx:DataGrid>
		<mx:HBox width="100%">
			<mx:Button label="Index Now" click="startIndexing()" />
			<mx:Spacer width="100%"/>
			<mx:Button  label="Delete Selected Feed" click="deleteRssFeed()"/>
		</mx:HBox>
			<mx:TextArea backgroundColor="0xCCCCCC" borderThickness="0" editable="false" width="500" height="100%" fontWeight="bold" text="The indexing is scheduled to run every hour. You can hit the Index Now button if you want to index your feeds you added recently. Please allow 10 -15 minutes for the results to show up."/>
		</mx:VBox>
		<ui:UserWindowSettings targetTool="{this}"/>
	</ui:ControlPanel>
</ui:DraggablePanel>