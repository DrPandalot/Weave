<?xml version="1.0" encoding="utf-8"?>
<!--
/*
    Weave (Web-based Analysis and Visualization Environment)
    Copyright (C) 2008-2011 University of Massachusetts Lowell

    This file is a part of Weave.

    Weave is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License, Version 3,
    as published by the Free Software Foundation.

    Weave is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with Weave.  If not, see <http://www.gnu.org/licenses/>.
*/
-->
<ui:DraggablePanel
	xmlns:mx="http://www.adobe.com/2006/mxml"
	xmlns="weave.editors.managers.*"
	xmlns:ui="weave.ui.*"
	borderAlpha="1"
	borderColor="#939178"
	borderThicknessLeft="{padding}"
	borderThicknessRight="{padding}"
	borderThicknessBottom="{padding}"
	title="{lang('Manage data sources')}">
	<mx:VBox width="100%" height="100%" verticalGap="0">
		<mx:HBox height="100%" width="100%" horizontalGap="0">
			<mx:VBox height="100%" initialize="UIUtils.setPadding(event.target as UIComponent, padding)">
				<mx:Button label="{lang('Browse data')}" click="AttributeSelectorPanel.openDefaultSelector();" width="100%"/>
				<mx:Button label="{lang('New data source...')}" click="addSource()" width="100%"/>
				<ui:Paragraph>
					Data sources:
				</ui:Paragraph>
				<mx:List id="sourceList"
						 change="handleSourceSelect()"
						 minHeight="0"
						 height="100%" width="100%"
						 dataProvider="{sources}"
						 labelFunction="getLabel"/>
				<mx:Button label="{lang('Remove selected')}" click="removeSelected()" width="100%"/>
			</mx:VBox>
			<mx:Canvas backgroundColor="#939178" width="{padding}" height="100%"/>
			<mx:VBox width="100%" height="100%" initialize="UIUtils.setPadding(event.target as UIComponent, padding)">
				<ui:Paragraph visible="{!sourceList.selectedItem}" includeInLayout="{!sourceList.selectedItem}">
					Select a data source to edit.
				</ui:Paragraph>
				<mx:Box id="container" minWidth="0" minHeight="0" width="100%" height="100%"/>
				<mx:HBox width="100%" visible="{!!sourceList.selectedItem}">
					<mx:Spacer width="100%"/>
					<mx:Button label="{lang('Apply changes')}" click="save()"/>
				</mx:HBox>
			</mx:VBox>
		</mx:HBox>
	</mx:VBox>
		
		<mx:Script>
			<![CDATA[
				import mx.core.UIComponent;
				import mx.managers.PopUpManager;
				
				import weave.Weave;
				import weave.api.WeaveAPI;
				import weave.api.core.ILinkableObject;
				import weave.api.data.IDataSource;
				import weave.api.ui.ILinkableObjectEditor;
				import weave.core.UIUtils;
				import weave.ui.AttributeSelectorPanel;
				import weave.utils.EditorManager;
				
				private static const padding:int = 5;
				[Bindable]
				private var sources:Array = new Array();
				
				override protected function childrenCreated():void
				{
					super.childrenCreated();
					
					pinnable.value = false;
					Weave.root.childListCallbacks.addGroupedCallback(this, updateSources, true);
				}
				
				private function updateSources():void
				{
					sourceList.selectedItem = null;
					sources = Weave.root.getObjects(IDataSource);
					handleSourceSelect();
				}
				
				private static var _staticInstance:EditDataSourcePanel = null;
				public static function showAsPopup():void
				{
					if (_staticInstance == null)
						_staticInstance = new EditDataSourcePanel();
					_staticInstance = PopUpManager.createPopUp(WeaveAPI.topLevelApplication as DisplayObject, EditDataSourcePanel, false) as EditDataSourcePanel;
					
					PopUpManager.centerPopUp(_staticInstance);
				}	
				
				private var editor:ILinkableObjectEditor = null;
				private function handleSourceSelect():void
				{
					container.removeAllChildren();
					editor = null;
					var dataSource:IDataSource = sourceList.selectedItem as IDataSource;
					if (dataSource)
					{
						editor = EditorManager.getNewEditor(dataSource);
						if (!editor)
							return;
						container.addChild(editor as DisplayObject);
						editor.percentWidth = 100;
						editor.percentHeight = 100;
					}
				}
				private function addSource():void
				{
					AddDataSourcePanel.showAsPopup();
				}
				private function removeSelected():void
				{
					Weave.root.removeObject(Weave.root.getName(sourceList.selectedItem as ILinkableObject));
				}
				
				private function save():void
				{
					if (editor != null)
						editor.applyChanges();
				}
				
				private function getLabel(item:Object):String
				{
					return Weave.root.getName(item as ILinkableObject);
				}
			]]>
		</mx:Script>
</ui:DraggablePanel>