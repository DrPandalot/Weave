<!DOCTYPE html>
<html lang="en" ng-app="aws.WeaveModule">
	<head>
		<meta charset="UTF-8" />
		<script src="/aws/lib/swfobject.js"></script>
		<script src="lib/jquery/jquery 2_1_0.js"></script>
		<script src='lib/jquery-ui/jquery-ui.js'></script>
		<script src="lib/angular/1.2/angular.min.js"></script>
		
		<script src="aws/visualization/weave/WeaveModule.js"></script>
		
	</head>
	<body ng-controller="WeaveCtrl">
		<script>
			var timer = null;
			var base_url = document.location.protocol + "//" + document.location.host + "/";
		    var client;
		    var result;
		    var colorColumn;
		    var responseResults;
		    var dataSourceName;
		    var checkstring;
		    var logvar;
		    var setSession;
			var isWeaveReady = false;
			
			function weaveReady(weave)
			{
				isWeaveReady = true;
				console.log(isWeaveReady);
			}

			var check;
			function workOnData(queryHandler, input)
			{
				check = queryHandler;
				//testing
				responseResults = input || responseResults;
				if(client)
				{
					var keyType = "";
					if(queryHandler.queryObject.MapTool.enabled){
						var geometryJson = JSON.parse(queryHandler.queryObject.MapTool.geometryLayer);
						console.log("geometry", geometryJson);
						keyType = geometryJson.keyType;
					}

					console.log("else");

					   //Todo parameterize keyColumnName ; here "fips"
					   dataSourceName = client.addCSVDataSource(responseResults,"", keyType, "fips");
					   var toolName;
					    //creating the visualizations
						for (var i in queryHandler.visualizations) {
							toolName = client.newVisualization(queryHandler.visualizations[i], dataSourceName);
							if(queryHandler.visualizations[i].hasOwnProperty("enableTitle")) {
								client.setVisualizationTitle(toolName, queryHandler.visualizations[i].enableTitle,  queryHandler.visualizations[i].title);
							}
							queryHandler.currentVisualizations[queryHandler.visualizations[i].type] = toolName;
							//console.log(queryHandler.visualizations[i]);
							//aws.timeLogString = aws.reportTime(queryHandler.visualizations[i].type + ' added');
							//$("#LogBox").append('<p>' + aws.timeLogString + '</p>');
						}

					   // var colColumn = aws.QueryHandler.prototype.returnColorcolumn();
					    if (queryHandler.ColorColumn) {
					    	colorColumn = queryHandler.ColorColumn;
							client.setColorAttribute(queryHandler.ColorColumn, dataSourceName);
							//aws.timeLogString = aws.reportTime('color column added');
							//$("#LogBox").append('<p>' + aws.timeLogString + '</p>');		
						}	
				}
			}

			function updateVisualizations(queryHandler){
				var toolName;
				log("Updating visualizations...");

				console.log("queryHandler.queryObject", queryHandler.queryObject);
				var keyType = "";
				//TODO find a better way to set the keytype;
				//check for the keytype
				if(queryHandler.queryObject.MapTool.enabled){

					var geometryJson = JSON.parse(queryHandler.queryObject.MapTool.geometryLayer);
					keyType = geometryJson.keyType;
				}

				//set the keyType of the csv datasource
				client.setCSVDataSouceKeyType(keyType);

				for(var i in queryHandler.visualizations){
					if (queryHandler.currentVisualizations.hasOwnProperty(queryHandler.visualizations[i].type)) {
						queryHandler.visualizations[i].toolName = queryHandler.currentVisualizations[queryHandler.visualizations[i].type];
					}

					toolName = client.updateVisualization(queryHandler.visualizations[i], dataSourceName);
					if(queryHandler.visualizations[i].hasOwnProperty("enableTitle")) {
						client.setVisualizationTitle(toolName, queryHandler.visualizations[i].enableTitle,  queryHandler.visualizations[i].title);
					}
					queryHandler.currentVisualizations[queryHandler.visualizations[i].type] = toolName;
				}

				 if (queryHandler.ColorColumn) {
				    	colorColumn = queryHandler.ColorColumn;
						client.setColorAttribute(queryHandler.ColorColumn, dataSourceName);
				 }
			}

			function clearSessionState(){
				if(client)
					client.clearWeave();
				log("Session State cleared");
			}

// 			function clearWeave() {
// 				if(client) {
// 					client.clearWeave(); 
// 				}
// 			}

			function resizeWeave( t )
			{
				if( typeof t == 'undefined' ) t = 3;
				if( t == 0 ) { timer = null; return; }
				if( timer != null ) {
					clearTimeout(timer);
					timer = null;
				}

				var dh = $(window).height() - 10;
				var wh = $("#weaveBox").position().top;
				var h =  dh - wh;
				$("#weaveBox").height( h );

				timer = setTimeout(
					function() {
						resizeWeave(t - 1);
					},
					300
				);
			}

			function setSessionHistory(base64encodedstring)
			{
				console.log("base64encodedstring", base64encodedstring);
				weave.path()
				.vars({encoded: base64encodedstring})
				.getValue("\
			        var d = new 'mx.utils.Base64Decoder'();\
					var decodedStuff = d.decode(encoded);\
					var decodeBytes =  d.toByteArray();\
			      Class('weave.Weave').loadWeaveFileContent(decodeBytes);\
			    ");


			}

			function getSessionState()
			{
				return weave.path().getValue("\
				        var e = new 'mx.utils.Base64Encoder'();\
				        e.encodeBytes( Class('weave.Weave').createWeaveFileContent(true) );\
				        return e.drain();\
				    ");
			}

		</script>

		<script>
			var obj;
			var qh;
			$(window).ready(function() {
				resizeWeave();
			});
			
			$(window).resize(function() {
				resizeWeave();
			});

		</script>

		<script type="text/javascript">
			// For version detection, set to min. required Flash Player version, or 0 (or 0.0.0), for no version detection. 
			var swfVersionStr = "10.2.0";
			// To use express install, set to playerProductInstall.swf, otherwise the empty string. 
			var xiSwfUrlStr = "playerProductInstall.swf";
			var flashvars = {};
			flashvars.file = "minimal.xml";
			flashvars.allowDomain = "*";
			var params = {};
			params.base = base_url;
			params.quality = "high";
			params.bgcolor = "#7B96B6";
			params.allowscriptaccess = "always";
			params.allowfullscreen = "true";
			var attributes = {};
			attributes.id = "weave";
			attributes.name = "weave";
			attributes.align = "middle";
			swfobject.embedSWF(
				base_url + "weave.swf", "flashContent", 
				"100%", "100%", 
				swfVersionStr, xiSwfUrlStr, 
				flashvars, params, attributes);
			// JavaScript enabled so display the flashContent div in case it is not replaced with a swf object.
			swfobject.createCSS("#flashContent", "display:block;text-align:left;width:100%;height:100%;");
		</script>

		<div id="weaveBox" style="width:100%; height:50%; overflow: hidden; margin: 0 auto;">
			<div id="flashContent">
				<p>
					To view this page ensure that Adobe Flash Player version 
					10.2.0 or greater is installed. 
				</p>
				<script type="text/javascript"> 
					var pageHost = ((document.location.protocol == "https:") ? "https://" : "http://"); 
					document.write("<a href='http://www.adobe.com/go/getflashplayer'><img src='" 
									+ pageHost + "www.adobe.com/images/shared/download_buttons/get_flash_player.gif' alt='Get Adobe Flash player' /></a>" ); 
				</script> 
			</div>
		</div>
	</body>
</html>