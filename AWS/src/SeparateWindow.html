<!DOCTYPE html>
	<head>
		<meta charset="UTF-8" />
		<script src="lib/jquery/jquery.js"></script>
		<script src="aws.js"></script>
		<script src="lib/swfobject.js"></script>
	</head>
	<body>
	<table border="0">
		  <tr>
		    <td>This page contains the Weave instance which will display all the visualizations. 
		<br>(1)If running a script, visualizations will be displayed on completion of computation</br>
			</td>
		    <td><textarea id="resultTextArea" width="100%" cols="100" rows="1"></textarea></td>
		  </tr>
	</table>
		
		<script>
			var timer = null;
			var base_url = document.location.protocol + "//" + document.location.host + "/";
		    var client;
		    var result;
		    var colorColumn;
		    var responseResults;
		    var dataSourceName;
		    
			function weaveReady(weave)
			{
				console.log( "Weave Ready" );
				resultTextArea.value = "Running Query on R ...";
				
				console.log("got weave instance");
			    client = new aws.WeaveClient(weave);
			    console.log("got weave client");
			   
			    // this will call WorkOnData if the results are available
			   if(responseResults) {
				   console.log("calling from weave ready", this);
				   workOnData(responseResults);
			   }
			}
			
			function workOnData(input)
			{
				//console.log("in workOnData(); " + JSON.abc);
				//responseResults = JSON.parse(JSON.stringify(input));//fixes bug with flash throwing up errors for object to array conversion across two browser windows
				
				//testing
				responseResults = input || responseResults;
				console.log(client.weave);
				console.log(responseResults);
				if(client.weave.path)
				{
						   resultTextArea.value = "Displaying results in visualizations...";
						   //Todo parameterize keyColumnName ; here "fips"
						   dataSourceName = client.addCSVDataSource(responseResults,"", this.keyType, "fips");
						   console.log(dataSourceName);
						   var toolName;
						    //creating the visualizations
						    console.log(this.visualizations);
							for (var i in this.visualizations) {
								console.log(i);
								toolName = client.newVisualization(this.visualizations[i], dataSourceName);
								this.currentVisualizations[this.visualizations[i].type] = toolName;
								console.log(this.currentVisualizations);
								//console.log(this.visualizations[i]);
								//aws.timeLogString = aws.reportTime(this.visualizations[i].type + ' added');
								//$("#LogBox").append('<p>' + aws.timeLogString + '</p>');
							}
								    
						   // var colColumn = aws.QueryHandler.prototype.returnColorcolumn();
						    if (this.ColorColumn) {
						    	colorColumn = this.ColorColumn;
								client.setColorAttribute(this.ColorColumn, dataSourceName);
								//aws.timeLogString = aws.reportTime('color column added');
								//$("#LogBox").append('<p>' + aws.timeLogString + '</p>');		
							}	
				}
			}
			
			function updateVisualizations(){
				
				var toolName;
				console.log(this);
				for(var i in this.visualizations){
					console.log(i);
					if (this.currentVisualizations.hasOwnProperty(this.visualizations[i].type)) {
						console.log(this.visualizations[i].type);
						this.visualizations[i].toolName = this.currentVisualizations[this.visualizations[i].type];
					}
					
					toolName = client.updateVisualization(this.visualizations[i], dataSourceName);
					console.log(toolName);
					this.currentVisualizations[this.visualizations[i].type] = toolName;
				}
				
				 if (this.ColorColumn) {
				    	colorColumn = this.ColorColumn;
						client.setColorAttribute(this.ColorColumn, dataSourceName);
				 }
			}
			
			function clearWeave() {
				client.clearWeave(); 
			}
			
			function resizeWeave( t )
			{
				if( typeof t == 'undefined' ) t = 3;
				if( t == 0 ) { timer = null; return; }
				if( timer != null ) {
					clearTimeout(timer);
					timer = null;
				}
	
				var dh = $(window).height() - 10;
				var wh = $("#weaveBox").position().top;
				var h =  dh - wh;
				$("#weaveBox").height( h );
				
				timer = setTimeout(
					function() {
						resizeWeave(t - 1);
					},
					300
				);
			}
			
		</script>
	
		<script>
			var obj;
			var qh;
			$(window).ready(function() {
				resizeWeave();
			});
			$(window).resize(function() {
				resizeWeave();
			});
			
		</script>
		
		<script type="text/javascript">
			// For version detection, set to min. required Flash Player version, or 0 (or 0.0.0), for no version detection. 
			var swfVersionStr = "10.2.0";
			// To use express install, set to playerProductInstall.swf, otherwise the empty string. 
			var xiSwfUrlStr = "playerProductInstall.swf";
			var flashvars = {};
			flashvars.file = "minimal.xml";
			flashvars.allowDomain = "*";
			var params = {};
			params.base = base_url;
			params.quality = "high";
			params.bgcolor = "#7B96B6";
			params.allowscriptaccess = "always";
			params.allowfullscreen = "true";
			var attributes = {};
			attributes.id = "weave";
			attributes.name = "weave";
			attributes.align = "middle";
			swfobject.embedSWF(
				base_url + "weave.swf", "flashContent", 
				"100%", "100%", 
				swfVersionStr, xiSwfUrlStr, 
				flashvars, params, attributes);
			// JavaScript enabled so display the flashContent div in case it is not replaced with a swf object.
			swfobject.createCSS("#flashContent", "display:block;text-align:left;width:100%;height:100%;");
		</script>
	
		<div id="weaveBox" style="width:100%; height:50%; overflow: hidden; margin: 0 auto;">
			<div id="flashContent">
				<p>
					To view this page ensure that Adobe Flash Player version 
					10.2.0 or greater is installed. 
				</p>
				<script type="text/javascript"> 
					var pageHost = ((document.location.protocol == "https:") ? "https://" : "http://"); 
					document.write("<a href='http://www.adobe.com/go/getflashplayer'><img src='" 
									+ pageHost + "www.adobe.com/images/shared/download_buttons/get_flash_player.gif' alt='Get Adobe Flash player' /></a>" ); 
				</script> 
			</div>
		</div>
	</body>
</html>
