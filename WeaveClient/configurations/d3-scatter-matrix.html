<!DOCTYPE html>

<div class="wd3sm">
<script src="http://d3js.org/d3.v3.min.js"></script>
<style>
	svg.wd3sm {
	  font: 10px sans-serif;
	  padding: 10px;
	}
	
	.wd3sm .axis,
	.wd3sm .frame {
	  shape-rendering: crispEdges;
	}
	
	.wd3sm .axis line {
	  stroke: #ddd;
	}
	
	.wd3sm .axis path {
	  display: none;
	}
	
	.wd3sm .frame {
	  fill: none;
	  stroke: #aaa;
	}
	
	.wd3sm circle {
	  fill-opacity: .7;
	}
</style>
<script>
	var scripts = document.getElementsByTagName( 'script' );
	var thisScriptTag = scripts[ scripts.length - 1 ];
	var div = thisScriptTag.parentNode;
	
	var width = 960,
	    size = 150,
	    padding = 19.5;
	
	var x = d3.scale.linear()
	    .range([padding / 2, size - padding / 2]);
	
	var y = d3.scale.linear()
	    .range([size - padding / 2, padding / 2]);
	
	var xAxis = d3.svg.axis()
	    .scale(x)
	    .orient("bottom")
	    .ticks(5);
	
	var yAxis = d3.svg.axis()
	    .scale(y)
	    .orient("left")
	    .ticks(5);
	
	var color = d3.scale.category10();
	
	function d3_scatter_matrix(div, data, titleLookup) {
		console.log(arguments);
	  var domainByTrait = {},
	      traits = d3.keys(data[0]).filter(function(name){ return !titleLookup || titleLookup[name]; }),
	      n = traits.length;
	  d3.select(div).select('svg').remove();
	  var svg = d3.select(div).append('svg')
		.attr("width", size * n + padding)
		.attr("height", size * n + padding)
		.append("g")
		.attr("transform", "translate(" + padding + "," + padding / 2 + ")");
	  
	  traits.forEach(function(trait) {
	    domainByTrait[trait] = d3.extent(data, function(d) { return d[trait]; });
	  });
	
	  xAxis.tickSize(size * n);
	  yAxis.tickSize(-size * n);
	
	  svg.selectAll(".x.axis")
	      .data(traits)
	    .enter().append("g")
	      .attr("class", "x axis")
	      .attr("transform", function(d, i) { return "translate(" + (n - i - 1) * size + ",0)"; })
	      .each(function(d) { x.domain(domainByTrait[d]); d3.select(this).call(xAxis); });
	
	  svg.selectAll(".y.axis")
	      .data(traits)
	    .enter().append("g")
	      .attr("class", "y axis")
	      .attr("transform", function(d, i) { return "translate(0," + i * size + ")"; })
	      .each(function(d) { y.domain(domainByTrait[d]); d3.select(this).call(yAxis); });
	
	  var cell = svg.selectAll(".cell")
	      .data(cross(traits, traits))
	    .enter().append("g")
	      .attr("class", "cell")
	      .attr("transform", function(d) { return "translate(" + (n - d.i - 1) * size + "," + d.j * size + ")"; })
	      .each(plot);
	
	  // Titles for the diagonal.
	  cell.filter(function(d) { return d.i === d.j; }).append("text")
	      .attr("x", padding)
	      .attr("y", padding)
	      .attr("dy", ".71em")
	      .text(function(d) { return titleLookup ? titleLookup[d.x] : d.x; });
	
	  function plot(p) {
	    var cell = d3.select(this);
	
	    x.domain(domainByTrait[p.x]);
	    y.domain(domainByTrait[p.y]);
	
	    cell.append("rect")
	        .attr("class", "frame")
	        .attr("x", padding / 2)
	        .attr("y", padding / 2)
	        .attr("width", size - padding)
	        .attr("height", size - padding);
	
	    cell.selectAll("circle")
	        .data(data)
	      .enter().append("circle")
	        .attr("cx", function(d) { return x(d[p.x]); })
	        .attr("cy", function(d) { return y(d[p.y]); })
	        .attr("r", 3)
	        .style("fill", function(d) { return color(d.species); });
	  }
	
	  function cross(a, b) {
	    var c = [], n = a.length, m = b.length, i, j;
	    for (i = -1; ++i < n;) for (j = -1; ++j < m;) c.push({x: a[i], i: i, y: b[j], j: j});
	    return c;
	  }
	
	  d3.select(self.frameElement).style("height", size * n + padding + 20 + "px");
	}
	//------------------
	
	// startup code
	var data = [
	        	{
	        		"a": 2,
	        		"b": 3,
	        		"c": 6,
	        		"d": 2
	        	},
	        	{
	        		"a": 6,
	        		"b": 5,
	        		"c": 8,
	        		"d": 3
	        	},
	        	{
	        		"a": 4,
	        		"b": 9,
	        		"c": 9,
	        		"d": 3
	        	},
	        	{
	        		"a": 7,
	        		"b": 5,
	        		"c": 2,
	        		"d": 5
	        	},
	        	{
	        		"a": 6,
	        		"b": 3,
	        		"c": 2,
	        		"d": 9
	        	},
	        	{
	        		"a": 2,
	        		"b": 8,
	        		"c": 8,
	        		"d": 4
	        	},
	        	{
	        		"a": 9,
	        		"b": 7,
	        		"c": 9,
	        		"d": 8
	        	},
	        	{
	        		"a": 1,
	        		"b": 1,
	        		"c": 5,
	        		"d": 6
	        	},
	        	{
	        		"a": 4,
	        		"b": 8,
	        		"c": 2,
	        		"d": 7
	        	},
	        	{
	        		"a": 4,
	        		"b": 6,
	        		"c": 2,
	        		"d": 1
	        	},
	        	{
	        		"a": 5,
	        		"b": 1,
	        		"c": 2,
	        		"d": 7
	        	},
	        	{
	        		"a": 5,
	        		"b": 1,
	        		"c": 6,
	        		"d": 8
	        	},
	        	{
	        		"a": 1,
	        		"b": 2,
	        		"c": 5,
	        		"d": 3
	        	},
	        	{
	        		"a": 3,
	        		"b": 9,
	        		"c": 6,
	        		"d": 2
	        	},
	        	{
	        		"a": 7,
	        		"b": 10,
	        		"c": 7,
	        		"d": 7
	        	},
	        	{
	        		"a": 3,
	        		"b": 8,
	        		"c": 7,
	        		"d": 7
	        	},
	        	{
	        		"a": 5,
	        		"b": 10,
	        		"c": 9,
	        		"d": 9
	        	},
	        	{
	        		"a": 2,
	        		"b": 5,
	        		"c": 7,
	        		"d": 8
	        	},
	        	{
	        		"a": 2,
	        		"b": 9,
	        		"c": 8,
	        		"d": 9
	        	},
	        	{
	        		"a": 8,
	        		"b": 10,
	        		"c": 3,
	        		"d": 6
	        	},
	        	{
	        		"a": 8,
	        		"b": 1,
	        		"c": 3,
	        		"d": 9
	        	},
	        	{
	        		"a": 9,
	        		"b": 1,
	        		"c": 3,
	        		"d": 5
	        	},
	        	{
	        		"a": 2,
	        		"b": 2,
	        		"c": 5,
	        		"d": 8
	        	},
	        	{
	        		"a": 7,
	        		"b": 1,
	        		"c": 10,
	        		"d": 8
	        	},
	        	{
	        		"a": 1,
	        		"b": 10,
	        		"c": 4,
	        		"d": 7
	        	},
	        	{
	        		"a": 4,
	        		"b": 10,
	        		"c": 6,
	        		"d": 9
	        	},
	        	{
	        		"a": 1,
	        		"b": 5,
	        		"c": 1,
	        		"d": 2
	        	},
	        	{
	        		"a": 8,
	        		"b": 9,
	        		"c": 10,
	        		"d": 10
	        	},
	        	{
	        		"a": 8,
	        		"b": 9,
	        		"c": 10,
	        		"d": 9
	        	},
	        	{
	        		"a": 2,
	        		"b": 8,
	        		"c": 4,
	        		"d": 9
	        	},
	        	{
	        		"a": 1,
	        		"b": 7,
	        		"c": 5,
	        		"d": 3
	        	},
	        	{
	        		"a": 8,
	        		"b": 2,
	        		"c": 9,
	        		"d": 6
	        	},
	        	{
	        		"a": 6,
	        		"b": 9,
	        		"c": 9,
	        		"d": 2
	        	},
	        	{
	        		"a": 1,
	        		"b": 7,
	        		"c": 3,
	        		"d": 5
	        	},
	        	{
	        		"a": 9,
	        		"b": 1,
	        		"c": 6,
	        		"d": 1
	        	},
	        	{
	        		"a": 9,
	        		"b": 1,
	        		"c": 2,
	        		"d": 4
	        	},
	        	{
	        		"a": 7,
	        		"b": 6,
	        		"c": 7,
	        		"d": 10
	        	},
	        	{
	        		"a": 5,
	        		"b": 2,
	        		"c": 8,
	        		"d": 7
	        	},
	        	{
	        		"a": 2,
	        		"b": 8,
	        		"c": 8,
	        		"d": 4
	        	},
	        	{
	        		"a": 2,
	        		"b": 7,
	        		"c": 8,
	        		"d": 3
	        	},
	        	{
	        		"a": 10,
	        		"b": 4,
	        		"c": 6,
	        		"d": 1
	        	},
	        	{
	        		"a": 10,
	        		"b": 10,
	        		"c": 10,
	        		"d": 7
	        	},
	        	{
	        		"a": 10,
	        		"b": 9,
	        		"c": 10,
	        		"d": 3
	        	},
	        	{
	        		"a": 10,
	        		"b": 1,
	        		"c": 10,
	        		"d": 4
	        	},
	        	{
	        		"a": 8,
	        		"b": 3,
	        		"c": 4,
	        		"d": 9
	        	},
	        	{
	        		"a": 6,
	        		"b": 4,
	        		"c": 3,
	        		"d": 9
	        	},
	        	{
	        		"a": 8,
	        		"b": 8,
	        		"c": 4,
	        		"d": 2
	        	},
	        	{
	        		"a": 7,
	        		"b": 6,
	        		"c": 7,
	        		"d": 5
	        	},
	        	{
	        		"a": 9,
	        		"b": 1,
	        		"c": 5,
	        		"d": 7
	        	},
	        	{
	        		"a": 1,
	        		"b": 6,
	        		"c": 3,
	        		"d": 6
	        	},
	        	{
	        		"a": 7,
	        		"b": 10,
	        		"c": 3,
	        		"d": 1
	        	},
	        	{
	        		"a": 5,
	        		"b": 8,
	        		"c": 6,
	        		"d": 6
	        	},
	        	{
	        		"a": 3,
	        		"b": 4,
	        		"c": 7,
	        		"d": 10
	        	},
	        	{
	        		"a": 9,
	        		"b": 9,
	        		"c": 2,
	        		"d": 8
	        	},
	        	{
	        		"a": 9,
	        		"b": 6,
	        		"c": 6,
	        		"d": 1
	        	},
	        	{
	        		"a": 9,
	        		"b": 5,
	        		"c": 1,
	        		"d": 10
	        	},
	        	{
	        		"a": 5,
	        		"b": 6,
	        		"c": 3,
	        		"d": 7
	        	},
	        	{
	        		"a": 8,
	        		"b": 9,
	        		"c": 2,
	        		"d": 4
	        	},
	        	{
	        		"a": 5,
	        		"b": 6,
	        		"c": 9,
	        		"d": 5
	        	},
	        	{
	        		"a": 3,
	        		"b": 6,
	        		"c": 10,
	        		"d": 4
	        	},
	        	{
	        		"a": 2,
	        		"b": 1,
	        		"c": 3,
	        		"d": 10
	        	},
	        	{
	        		"a": 4,
	        		"b": 8,
	        		"c": 2,
	        		"d": 3
	        	},
	        	{
	        		"a": 3,
	        		"b": 10,
	        		"c": 2,
	        		"d": 6
	        	},
	        	{
	        		"a": 10,
	        		"b": 7,
	        		"c": 9,
	        		"d": 8
	        	},
	        	{
	        		"a": 1,
	        		"b": 2,
	        		"c": 8,
	        		"d": 8
	        	},
	        	{
	        		"a": 1,
	        		"b": 2,
	        		"c": 5,
	        		"d": 10
	        	},
	        	{
	        		"a": 7,
	        		"b": 5,
	        		"c": 3,
	        		"d": 3
	        	},
	        	{
	        		"a": 1,
	        		"b": 3,
	        		"c": 2,
	        		"d": 8
	        	},
	        	{
	        		"a": 4,
	        		"b": 5,
	        		"c": 1,
	        		"d": 6
	        	},
	        	{
	        		"a": 10,
	        		"b": 4,
	        		"c": 10,
	        		"d": 5
	        	},
	        	{
	        		"a": 3,
	        		"b": 9,
	        		"c": 9,
	        		"d": 6
	        	},
	        	{
	        		"a": 7,
	        		"b": 7,
	        		"c": 1,
	        		"d": 7
	        	},
	        	{
	        		"a": 3,
	        		"b": 1,
	        		"c": 10,
	        		"d": 6
	        	},
	        	{
	        		"a": 8,
	        		"b": 2,
	        		"c": 8,
	        		"d": 5
	        	},
	        	{
	        		"a": 8,
	        		"b": 5,
	        		"c": 5,
	        		"d": 8
	        	},
	        	{
	        		"a": 4,
	        		"b": 6,
	        		"c": 8,
	        		"d": 10
	        	},
	        	{
	        		"a": 4,
	        		"b": 5,
	        		"c": 2,
	        		"d": 6
	        	},
	        	{
	        		"a": 6,
	        		"b": 9,
	        		"c": 6,
	        		"d": 7
	        	},
	        	{
	        		"a": 9,
	        		"b": 3,
	        		"c": 10,
	        		"d": 2
	        	},
	        	{
	        		"a": 9,
	        		"b": 3,
	        		"c": 2,
	        		"d": 2
	        	},
	        	{
	        		"a": 2,
	        		"b": 7,
	        		"c": 9,
	        		"d": 7
	        	},
	        	{
	        		"a": 7,
	        		"b": 8,
	        		"c": 8,
	        		"d": 6
	        	},
	        	{
	        		"a": 7,
	        		"b": 8,
	        		"c": 6,
	        		"d": 1
	        	},
	        	{
	        		"a": 5,
	        		"b": 6,
	        		"c": 3,
	        		"d": 10
	        	},
	        	{
	        		"a": 9,
	        		"b": 4,
	        		"c": 8,
	        		"d": 8
	        	},
	        	{
	        		"a": 10,
	        		"b": 7,
	        		"c": 10,
	        		"d": 9
	        	},
	        	{
	        		"a": 5,
	        		"b": 6,
	        		"c": 10,
	        		"d": 2
	        	},
	        	{
	        		"a": 8,
	        		"b": 8,
	        		"c": 10,
	        		"d": 5
	        	},
	        	{
	        		"a": 6,
	        		"b": 1,
	        		"c": 7,
	        		"d": 10
	        	},
	        	{
	        		"a": 4,
	        		"b": 5,
	        		"c": 5,
	        		"d": 6
	        	},
	        	{
	        		"a": 6,
	        		"b": 3,
	        		"c": 9,
	        		"d": 5
	        	},
	        	{
	        		"a": 6,
	        		"b": 9,
	        		"c": 10,
	        		"d": 9
	        	},
	        	{
	        		"a": 5,
	        		"b": 1,
	        		"c": 10,
	        		"d": 1
	        	},
	        	{
	        		"a": 9,
	        		"b": 7,
	        		"c": 8,
	        		"d": 7
	        	},
	        	{
	        		"a": 6,
	        		"b": 7,
	        		"c": 10,
	        		"d": 7
	        	},
	        	{
	        		"a": 9,
	        		"b": 10,
	        		"c": 2,
	        		"d": 2
	        	},
	        	{
	        		"a": 10,
	        		"b": 4,
	        		"c": 3,
	        		"d": 1
	        	},
	        	{
	        		"a": 4,
	        		"b": 8,
	        		"c": 8,
	        		"d": 10
	        	},
	        	{
	        		"a": 7,
	        		"b": 5,
	        		"c": 1,
	        		"d": 9
	        	},
	        	{
	        		"a": 2,
	        		"b": 5,
	        		"c": 9,
	        		"d": 9
	        	}
	        ];
	
	document.addEventListener("DOMContentLoaded", function() {
	    d3_scatter_matrix(div, data);
	});
	
	// weave external tool code
	if (opener && opener.WeaveExternalTools)
	{
		var toolPath = opener.WeaveExternalTools[window.name].path;
		var isNumericColumn = toolPath.getValue("name => this.getObject(name) is IAttributeColumn && this.getObject(name).getMetadata('dataType') == 'number'", null, ['weave.api.data.IAttributeColumn']);
		var getTitle = toolPath.weave.evaluateExpression(null, "col => col.getMetadata('title')");
		toolPath.addCallback(function(){
			var numericColumns = toolPath.getNames().filter(isNumericColumn);
			var titleLookup = {};
			numericColumns.forEach(function(name){ titleLookup[name] = getTitle(toolPath.push(name)); });
			data = toolPath.retrieveRecords(numericColumns);
			d3_scatter_matrix(div, data, titleLookup);
		}, true);
	}
</script>
</div>
